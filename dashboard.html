<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plasma Wallet Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="nav.js"></script>
</head>
<body>

<header>
  <h1>Your Plasma Wallet</h1>
</header>

<main>
  <section>
    <div id="walletOutput" class="transfer-info">
      Loading wallet...
    </div>
  </section>
</main>

<footer>
  <p>&copy; 2026 Plasma</p>
</footer>

<!-- EVERYTHING MERGED BELOW -->
<script type="module">
  console.log("‚úÖ dashboard script loaded");

  import {
    Wallet,
    JsonRpcProvider,
    formatEther,
    Network
  } from "https://cdn.jsdelivr.net/npm/ethers@6.16.0/dist/ethers.min.js";

  console.log("‚úÖ ethers imported");

  // Check if user is logged in
  const storedUser = sessionStorage.getItem("plasmaUser");
  const storedPrivateKey = sessionStorage.getItem("plasmaPrivateKey");

  let wallet_key;
  let userProfile;

  if (storedUser && storedPrivateKey) {
    // User logged in via backend
    userProfile = JSON.parse(storedUser);
    wallet_key = storedPrivateKey;
    console.log("üîë Loaded user wallet");
    console.log("üë§ User:", userProfile.username);
  } else {
    // Try legacy localStorage (for backward compatibility)
    const legacyWallet = localStorage.getItem("plasmaUserWallet");
    const legacyProfile = sessionStorage.getItem("plasmaUserProfile");

    if (legacyWallet) {
      const walletData = JSON.parse(legacyWallet);
      wallet_key = walletData.privateKey;
      console.log("üîë Loaded legacy wallet");
    } else {
      // Not logged in - redirect to login
      console.warn("‚ö†Ô∏è No active session");
      window.location.href = "login.html";
      throw new Error("Not logged in");
    }

    if (legacyProfile) {
      userProfile = JSON.parse(legacyProfile);
    }
  }

  console.log("üîë Wallet key length:", wallet_key.length);

  // Connect to Plasma Testnet (with ENS disabled)
  const plasmaNetwork = Network.from({
    name: "plasma-testnet",
    chainId: 9746
  });

  const provider = new JsonRpcProvider("https://testnet-rpc.plasma.to", plasmaNetwork, {
    staticNetwork: true,
    ensAddress: null
  });
  console.log("üåê Provider created");

  // Load wallet
  const wallet = new Wallet(wallet_key, provider);
  console.log("üëõ Wallet address:", wallet.address);

  const output = document.getElementById("walletOutput");
  if (!output) {
    console.error("‚ùå walletOutput div not found");
  } else {
    console.log("‚úÖ walletOutput div found");
  }

  async function updateBalance() {
    try {
      console.log("üîÑ Fetching balance...");
      const balanceWei = await provider.getBalance(wallet.address);
      const balanceXPL = formatEther(balanceWei);

      const greeting = userProfile
        ? `<p><strong>Welcome, ${userProfile.forename} ${userProfile.surname}!</strong> (@${userProfile.username})</p>`
        : '';

      output.innerHTML = `
        ${greeting}
        <p><strong>Wallet:</strong><br>${wallet.address}</p>
        <p><strong>Balance:</strong> ${balanceXPL} XPL</p>
        <p><em>Last updated: ${new Date().toLocaleTimeString()}</em></p>
        <p style="margin-top: 20px;">
          <a href="send.html" style="padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px; display: inline-block; margin-right: 10px;">
            Send Crypto Link
          </a>
          <button onclick="logout()" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Logout
          </button>
        </p>
      `;

      console.log("‚úÖ Balance updated:", balanceXPL);
    } catch (err) {
      console.error("‚ùå Balance fetch failed:", err);
      output.innerText = "Failed to load wallet balance. Check console.";
    }
  }

  // Run immediately
  updateBalance();

  // Poll every 5 seconds
  setInterval(updateBalance, 5000);

  // Logout function (make it global)
  window.logout = function() {
    sessionStorage.clear();
    localStorage.removeItem("plasmaUserWallet");
    window.location.href = "login.html";
  };
</script>

</body>
</html>
